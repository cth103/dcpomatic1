\documentclass{article}
\usepackage{url,amsmath,mathtools}
\usepackage[landscape]{geometry}
\title{Colour conversions for DCP creation}
\author{Carl Hetherington, Dennis Couzin}
\date{}
\begin{document}
\maketitle

\section{Overview}

The process of conversion from RGB to XYZ is:

\begin{enumerate}
\item Convert to linear RGB (i.e.\ apply a gamma curve, or at least an approximation to one).
\item Convert to XYZ.
\item Adjust the white point.
\item Normalize values.
\item Convert to non-linear XYZ (i.e.\ apply a gamma curve)
\end{enumerate}


\section{Conversion to linear RGB}

This is done using either a `pure' gamma function, so that for some colour value $C_i$ the output colour $C_o$ is given by

\begin{align*}
C_o &= C_i ^ \gamma
\end{align*}

or a modified function of the form

\begin{align*}
C_o &= \left\{
\begin{array}{ll}
\frac{C_i}{K} & C_i \leq C_t \\
\left( \frac{C_i + A}{1 + A} \right)^\zeta & C_i > C_t
\end{array}
\right.
\end{align*}

where $K$, $A$, $C_t$ and $\zeta$ are constants.  This modified function approximates a `pure' gamma function but changes the output for small inputs.


\section{Conversion to XYZ and white point adjustment}

This is done by multiplying the colours by a $3\times{}3$ matrix.
This matrix depends on the chromaticities of the RGB primaries and the
white point.  Note that these are the same for BT709 and sRGB, so the
corresponding matrices are the same.

The chromaticities for sRGB and BT709 are shown in
Table~\ref{tab:chromaticities}.  The white point is ($x = 0.3127$, $y
= 0.329$); this is called D65.

\begin{table}[ht]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
& $x$ & $y$ \\
\hline
Red & 0.64 & 0.33 \\
\hline
Green & 0.3 & 0.6 \\
\hline
Blue & 0.15 & 0.06 \\
\hline
\end{tabular}
\end{center}
\caption{RGB chromaticities for sRGB and BT709}
\label{tab:chromaticities}
\end{table}

Let

\begin{align}
D &= \left|\begin{matrix} R_x - W_x & W_x - B_x \\ R_y - W_y & W_y - B_y \end{matrix} \right| \\
E &= \left|\begin{matrix} W_x - G_x & R_x - W_x \\ W_y - G_y & R_y - W_y \end{matrix} \right| \\
F &= \left|\begin{matrix} W_x - G_x & W_x - B_x \\ W_y - G_y & W_y - B_y \end{matrix} \right| \\
P &= R_y + G_y \frac{D}{F} + B_y \frac{E}{F}
\end{align}

where:

\begin{itemize}
\item $R_x$, $R_y$: red point; $R_z = 1 - R_x - R_y$
\item $G_x$, $G_y$: green point; $G_z = 1 - G_x - G_y$
\item $B_x$, $B_y$: blue point; $B_z = 1 - B_x - B_y$
\item $W_x$, $W_y$: white point
\end{itemize}

Then the conversion matrix $M$ is as follows:

\begin{align}
M &= \frac{1}{P} \left[\begin{matrix}
R_x & G_x\dfrac{D}{F} & B_x\dfrac{E}{F} \\[2ex]
R_y & G_y\dfrac{D}{F} & B_y\dfrac{E}{F} \\[2ex]
R_z & G_z\dfrac{D}{F} & B_z\dfrac{E}{F} \\[2ex]
\end{matrix}\right] = \left[\begin{matrix}
0.4123908 & 0.3575843 & 0.1804808 \\
0.2126390 & 0.7151687 & 0.0721923 \\
0.0193308 & 0.1191948 & 0.9505322 \\
\end{matrix}\right]
\end{align}

Then to convert RGB to XYZ we do

\begin{align}
\left[\begin{matrix} X \\ Y \\ Z \\ \end{matrix}\right] &= M \left[\begin{matrix} R \\ G \\ B \\ \end{matrix}\right]
\intertext{i.e.}
\left[\begin{matrix} X \\ Y \\ Z \\ \end{matrix}\right] &= \left[\begin{matrix}
0.4123908 & 0.3575843 & 0.1804808 \\
0.2126390 & 0.7151687 & 0.0721923 \\
0.0193308 & 0.1191948 & 0.9505322 \\
\end{matrix}\right] \left[\begin{matrix} R \\ G \\ B \\ \end{matrix}\right]
\end{align}

Note: there is also a CIE definition of the D65 white point as ($x =
0.31272$, $y = 0.32903$), which we do not use.



\section{Comparing different software}

\subsection{sRGB to XYZ}

\begin{minipage}{\textwidth}
\begin{tabular}{|l|c|c|c|}
\hline
& \textbf{DCP-o-matic version 1.x}
& \textbf{DCP-o-matic version 2.x}
& \textbf{fnordware}\footnote{\url{https://github.com/fnordware/DCIconverter/tree/master/src}} \\

\hline
& & & \\
\parbox[c][2em][c]{2cm}{\textbf{Input gamma correction}} &
$C_o = \left\{ \begin{array}{ll} \frac{C_i}{12.92} & C_i \leq 0.04045 \\ \left(\frac{C_i + 0.055}{1.055}\right)^{2.4} & C_i > 0.04045 \end{array} \right.$ &
$C_o = \left\{ \begin{array}{ll} \frac{C_i}{12.92} & C_i \leq 0.04045 \\ \left(\frac{C_i + 0.055}{1.055}\right)^{2.4} & C_i > 0.04045 \end{array} \right.$ &
$C_o = \left\{ \begin{array}{ll} \frac{C_i}{12.92} & C_i \leq 0.04045 \\ \left(\frac{C_i + 0.055}{1.055}\right)^{2.4} & C_i > 0.04045 \end{array} \right.$ \\
& & & \\

\hline
& & & \\
\textbf{RGB to XYZ} &
$\left[\begin{array}{lll} 0.4124564 & 0.3575761 & 0.1804375 \\
                          0.2126729 & 0.7151522 & 0.0721750 \\
	                  0.0193339 & 0.1191920 & 0.9503041 \end{array}\right]$ &

$\left[\begin{array}{lll} 0.4124564 & 0.3575761 & 0.1804375 \\
                          0.2126729 & 0.7151522 & 0.0721750 \\
	                  0.0193339 & 0.1191920 & 0.9503041 \end{array}\right]$ &

$\left[\begin{array}{lll} 0.4124 & 0.3576 & 0.1805 \\
                          0.2126 & 0.7152 & 0.0722 \\
                          0.0193 & 0.1192 & 0.9505 \end{array}\right]$ \\[2em]

\hline
\textbf{Normalisation} &
\parbox[c][4em][c]{3cm}{ \(\displaystyle C_o = \frac{48 C_i}{52.37}\)} &
\parbox[c][4em][c]{3cm}{ \(\displaystyle C_o = \frac{48 C_i}{52.37}\)} &
\parbox[c][4em][c]{3cm}{ \(\displaystyle C_o = \frac{48 C_i}{52.37}\)} \\

\hline
\parbox[c][2em][c]{2cm}{\textbf{Output gamma correction}} &
\parbox[c][4em][c]{3cm}{\(\displaystyle C_o = C_i^{\frac{1}{2.6}} \)} &
\parbox[c][4em][c]{3cm}{\(\displaystyle C_o = C_i^{\frac{1}{2.6}} \)} &
\parbox[c][4em][c]{3cm}{\(\displaystyle C_o = C_i^{\frac{1}{2.6}} \)} \\
\hline

\end{tabular}
\end{minipage}




\subsection{Rec.\ 709 to XYZ}

\begin{minipage}{\textwidth}
\begin{tabular}{|l|c|c|c|}
\hline
& \textbf{DCP-o-matic version 1.x}
& \textbf{DCP-o-matic version 2.x}
& \textbf{fnordware}\footnote{\url{https://github.com/fnordware/DCIconverter/tree/master/src}} \\

\hline
& & & \\
\parbox[c][2em][c]{2cm}{\textbf{Input gamma correction}} &
\parbox[c][2em][c]{2cm}{$C_o = C_i^{2.2}$} &
$C_o = \left\{ \begin{array}{ll} \frac{C_i}{4.5} & C_i \leq 0.081 \\ \left(\frac{C_i + 0.099}{1.099}\right)^{1/0.45} & C_i > 0.081 \end{array} \right.$ &
$C_o = \left\{ \begin{array}{ll} \frac{C_i}{4.5} & C_i \leq 0.081 \\ \left(\frac{C_i + 0.099}{1.099}\right)^{1/0.45} & C_i > 0.081 \end{array} \right.$ \\

& & & \\
\hline
& & & \\
\textbf{RGB to XYZ} &
$\left[\begin{array}{lll} 0.4123908 & 0.3575843 & 0.1804808 \\
                          0.2126390 & 0.7151687 & 0.0721923 \\
                          0.0193308 & 0.1191948 & 0.9505321 \end{array}\right]$ &
$\left[\begin{array}{lll} 0.4123908 & 0.3575843 & 0.1804808 \\
                          0.2126390 & 0.7151687 & 0.0721923 \\
                          0.0193308 & 0.1191948 & 0.9505321 \end{array}\right]$ &
$\left[\begin{array}{lll} 0.4124 & 0.3576 & 0.1805 \\
                          0.2126 & 0.7152 & 0.0722 \\
                          0.0193 & 0.1192 & 0.9505 \end{array}\right]$ \\[2em]

\hline
\textbf{Normalisation} &
\parbox[c][4em][c]{3cm}{ \(\displaystyle C_o = \frac{48 C_i}{52.37}\)} &
\parbox[c][4em][c]{3cm}{ \(\displaystyle C_o = \frac{48 C_i}{52.37}\)} &
\parbox[c][4em][c]{3cm}{ \(\displaystyle C_o = \frac{48 C_i}{52.37}\)} \\

\hline
\parbox[c][2em][c]{2cm}{\textbf{Output gamma correction}} &
\parbox[c][4em][c]{3cm}{\(\displaystyle C_o = C_i^{\frac{1}{2.6}} \)} &
\parbox[c][4em][c]{3cm}{\(\displaystyle C_o = C_i^{\frac{1}{2.6}} \)} &
\parbox[c][4em][c]{3cm}{\(\displaystyle C_o = C_i^{\frac{1}{2.6}} \)} \\
\hline

\end{tabular}
\end{minipage}

\end{document}
